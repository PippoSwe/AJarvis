<!DOCTYPE html>
<html>
<head>
    <title>Keywords | AJarvis</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <!--#include virtual="/assets/tpl/meta.html"-->  
    <script type="text/javascript">
            function Controller(page) {
                this.page = page;
                this.onClickDelete = function(selector) {
                    var ref = this;
                    $(selector).click(function() {
                        var data_id = $(this).attr("data-id");
                        var div_id = "#list-item-"+data_id;
                        $("body").on('click', '#confirm-delete', function () {
                            $.ajax({
                                url: ref.page+data_id,
                                type: "DELETE",
                                success: function(data) {
                                    $("div").remove(div_id);
                                    var structure = {strong:"Eliminazione della keyword avvenuta con successo", class:"success", t:"", dismiss:"alert-dismissible fade show"}; //passo i messaggi per riusare il file mst
                                    $.get('alert.mst', function(template) {
                                        var rendered = Mustache.render(template, {items: structure}); //richiede un'array associativo
                                        $('#error').html(rendered);
                                    });
                                },
                                error: function(xhr, status, text) {
                                    var structure = {x:xhr, s:status, t:text, class:"danger", strong:"Errore!", dismiss:"alert-dismissible fade show"};
                                    $.get('alert.mst', function(template) {
                                        var rendered = Mustache.render(template, {items: structure}); //richiede un'array associativo
                                        $('#error').html(rendered);
                                    });
                                }
                            });
                        });
                    });
                };
                this.onClickEdit = function(selector) {
                    var ref = this;
                    $(selector).click(function() {
                        var data_id = $(this).attr("data-id");
                        $.ajax({
                            url: ref.page+data_id,
                            type: "GET",
                            success: function(data) {
                                ref.inizializeUpdateForm(data);
                                $("#save-modal").modal("show");
                            },
                            error: function(xhr, status, text) {
                                var structure = {x:xhr, s:status, t:text, class:"danger", strong:"Errore!", dismiss:"alert-dismissible fade show"};
                                $.get('alert.mst', function(template) {
                                    var rendered = Mustache.render(template, {items: structure}); //richiede un'array associativo
                                    $('#error').html(rendered);
                                });
                            }
                        });
                    });
                };
                this.onClickSave = function() {
                    var ref = this;
                    $("#btn-insert").click(function() {
                        ref.inizializeInsertForm();
                        $("#save-modal").modal("show");
                    });
                    ref.checkSaveButton();
                    $("#confirm-save").click(function(event) {
                        $.ajax({
                            url: $("#save").attr("action"),
                            type: $("#save").attr("method"),
                            data: $("#save").serialize(),
                            success: function(data) {
                                $("#save-modal").modal("hide");
                                var structure = {strong:"Salvataggio avvenuto avvenuto", class:"success", t:""}; //passo i messaggi per riusare il file mst
                                $.get('alert.mst', function(template) {
                                    var rendered = Mustache.render(template, {items: structure}); //richiede un'array associativo
                                    $('#error').html(rendered);
                                });
                                ref.loadList();
                            },
                            error: function(xhr, status, text) {
                                var structure = {x:xhr, s:status, t:text, class:"danger", strong:"Errore!"};
                                $.get('alert.mst', function(template) {
                                    var rendered = Mustache.render(template, {items: structure}); //richiede un'array associativo
                                    $('#error').html(rendered);
                                });
                            }
                        });
                    });
                };
                this.saveEnabled = function() {
                    if ($("#keyword").val().length == 0) {
                        $("#confirm-save").attr("disabled",true);
                        return;
                    }
                    $("#confirm-save").attr("disabled",false);
                };
                this.inizializeInsertForm = function() {
                    $("#save-title").html("Inserisci una nuova keyword");
                    $("#confirm-save").attr("disabled",true);
                    $("#save").attr("method","POST");
                    $("#save").attr("action",this.page);
                    $("#keyword").val("");
                };
                this.inizializeUpdateForm = function(data) {
                    $("#save-title").html("Modifica keyword: "+data.keyword);
                    $("#confirm-save").attr("disabled",false);
                    $("#save").attr("method","PUT");
                    $("#save").attr("action",this.page+data.id);
                    $("#keyword").val(data.keyword);
                };
                this.checkSaveButton = function() {
                    var ref = this;
                    $("#keyword").keyup(function() {
                        ref.saveEnabled();
                    });
                };
                this.loadList = function() {
                    var ref = this;
                    $.ajax({
                        url: this.page,
                        type: "GET",
                        success: function(data) {
                            $.get('keyword.mst', function(template) {
                                var rendered = Mustache.render(template, {items: data});
                                $('#list').html(rendered);
                                ref.onClickDelete(".delete");
                                ref.onClickEdit(".edit");
                            });
                        },
                        error: function(xhr, status, text) {
                            alert(xhr.responseText);
                        }
                    });
                };
            };

            $(document).ready(function(){
                var c = new Controller("/api/keyword/");
                c.loadList();
                c.onClickSave();
            });
</script>
</head>
<body>
        <div class="app">
            <div class="app-body">
                <!--#include virtual="/assets/tpl/sidebar.html"-->
                
                <div class="app-content">
                    <!--#include virtual="/assets/tpl/navbar.html"-->
                    <!-- breadcrumb -->
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item">Home</li>
                            <li class="breadcrumb-item active" aria-current="page">Keywords</li>
                        </ol>
                    </nav>
                    <!-- content -->
                    <div class="container-fluid">
                        <div id="error"></div>
                        <div class="container mt-lg-1">
                            <div class="row">
                                <div class="col-6 mt-lg-5">
                                    <a id="btn-insert" class="btn btn-success" href="#" role="button"><span class="ion-ios-plus-outline mr-2"></span>Nuova keyword</a>
                                </div>
                            </div>
                        </div>
                        <!-- Managing projects -->
                        <div class="container mt-5 mt-lg-5" id="list"> &nbsp </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Modal -->
        <div class="modal fade" id="exampleModalCenter" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLongTitle">Attenzione!</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        Eliminare definitivamente la keyword?
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Chiudi</button>
                        <button type="button" id="confirm-delete" class="btn btn-danger" data-dismiss="modal"><span class="ion-ios-trash-outline mr-2"></span>Elimina</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- insert modal -->
        <div class="modal fade hide" id="save-modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="save-title"></h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="save" method="" action="">
                            <div class="form-group">
                                <label for="keyword" class="col-form-label">Keyword:</label>
                                <input type="text" class="form-control" id="keyword" name="keyword" placeholder="Keyword" data-placement="right" required>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Chiudi</button>
                        <button type="button" id="confirm-save" class="btn btn-success" disabled="disabled"><span class="ion-ios-checkmark-outline mr-2"></span>Salva</button>
                    </div>
                </div>
            </div>
        </div>
    
        
</body>
</html>